#!/usr/bin/env python3
from flask import Blueprint, jsonify, request
from api.extensions import db
from api.models.session import Session
from api.tmdb_client import tmdb_get, tmdb_post, tmdb_delete
from datetime import datetime

bp = Blueprint("auth", __name__, url_prefix="/auth")

@bp.get("/guest-session")
def create_guest_session():
    """
    Create a TMDB guest session (no user login)
    ---
    tags:
      - Auth
    responses:
      200:
        description: Guest session created
    """
    payload, status = tmdb_get("/authentication/guest_session/new")
    if status != 200:
        return jsonify(payload), status

    guest_id = payload.get("guest_session_id")
    if guest_id:
        db.session.add(Session(tmdb_session_id=guest_id))
        db.session.commit()

    return jsonify({"guest_session_id": guest_id}), 200

@bp.post("/login-session")
def create_login_session():
    """
    Create a TMDB user session via login flow:
      1) create request token
      2) validate with login
      3) create session
    ---
    tags:
      - Auth
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [username, password]
            properties:
              username: { type: string }
              password: { type: string }
    responses:
      200:
        description: User session created
      400:
        description: Missing fields
    """
    body = request.get_json(silent=True) or {}
    username = body.get("username")
    password = body.get("password")
    if not username or not password:
        return jsonify({"error": "Missing username or password"}), 400

    token_payload, status = tmdb_get("/authentication/token/new")
    if status != 200:
        return jsonify(token_payload), status
    request_token = token_payload.get("request_token")

    validate_payload, status = tmdb_post(
        "/authentication/token/validate_with_login",
        json_body={"username": username, "password": password, "request_token": request_token},
    )
    if status != 200:
        return jsonify(validate_payload), status

    session_payload, status = tmdb_post(
        "/authentication/session/new",
        json_body={"request_token": request_token},
    )
    if status != 200:
        return jsonify(session_payload), status

    tmdb_session_id = session_payload.get("session_id")
    if tmdb_session_id:
        db.session.add(Session(tmdb_session_id=tmdb_session_id))
        db.session.commit()

    return jsonify({"session_id": tmdb_session_id}), 200

@bp.delete("/logout")
def logout_session():
    """
    Delete (logout) a TMDB user session
    ---
    tags:
      - Auth
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            required: [session_id]
            properties:
              session_id: { type: string }
    responses:
      200:
        description: Logged out
      400:
        description: Missing session_id
    """
    body = request.get_json(silent=True) or {}
    session_id = body.get("session_id")
    if not session_id:
        return jsonify({"error": "Missing session_id"}), 400

    payload, status = tmdb_delete(
        "/authentication/session",
        json_body={"session_id": session_id}
    )
    # Mark the session as revoked in the local database for soft logout
    s = Session.query.filter_by(tmdb_session_id=session_id).first()
    if s:
        s.revoked_at = db.func.now()
        db.session.commit()
        db.session.commit()

    return jsonify(payload), status
